esphome:
  name: m5stack-tab5-v2
  friendly_name: M5Stack Tab5 V2
  min_version: 2025.9.3
  on_boot:
    priority: -100
    then:
      - lambda: |-
          id(last_touch_time) = millis();

esp32:
  board: esp32-p4-evboard
  flash_size: 16MB
  framework:
    type: esp-idf
    advanced:
      enable_idf_experimental_features: true

# External components for ST7123
external_components:
  - source: github://pr#12075
    components: [st7123]
    refresh: 0s
  - source: github://pr#12074
    components: [mipi_dsi]
    refresh: 0s

# WiFi via ESP32-C6
esp32_hosted:
  variant: esp32c6
  active_high: true
  clk_pin: GPIO12
  cmd_pin: GPIO13
  d0_pin: GPIO11
  d1_pin: GPIO10
  d2_pin: GPIO9
  d3_pin: GPIO8
  reset_pin: GPIO15
  slot: 1

logger:
  hardware_uart: USB_SERIAL_JTAG

psram:
  mode: hex
  speed: 200MHz

# API Home Assistant
api:

# OTA
ota:
  - platform: esphome

# WiFi configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

# I2C bus
i2c:
  - id: bsp_bus
    sda: GPIO31
    scl: GPIO32
    frequency: 200kHz

# GPIO controllers
pi4ioe5v6408:
  - id: pi4ioe1
    address: 0x43
  - id: pi4ioe2
    address: 0x44

# Power switches
switch:
  - platform: gpio
    id: wifi_power
    pin:
      pi4ioe5v6408: pi4ioe2
      number: 0
    restore_mode: ALWAYS_ON
    internal: true

# LDO voltage regulator
esp_ldo:
  - voltage: 2.5V
    channel: 3

# PWM for backlight
output:
  - platform: ledc
    pin: GPIO22
    id: backlight_pwm
    frequency: 1000Hz

# Backlight
light:
  - platform: monochromatic
    output: backlight_pwm
    name: "Display Backlight"
    id: backlight
    restore_mode: ALWAYS_ON
    default_transition_length: 0.3s
    on_turn_on:
      - light.turn_on:
          id: backlight
          brightness: 20%

# Touchscreen ST7123 (V2)
touchscreen:
  - platform: st7123
    id: touch_panel
    i2c_id: bsp_bus
    interrupt_pin: GPIO23
    reset_pin:
      pi4ioe5v6408: pi4ioe1
      number: 5
    on_touch:
      - lambda: |-
          id(last_touch_time) = millis();
          if (!id(backlight).remote_values.is_on()) {
            // Screen was off, wake it up
            auto call = id(backlight).turn_on();
            call.set_brightness(0.2);
            call.perform();
            // Set flag to ignore button presses for 300ms
            id(screen_just_woke_up) = true;
            ESP_LOGD("backlight", "Screen woke up, ignoring touches for 300ms");
          }
    on_release:
      - delay: 300ms
      - lambda: |-
          if (id(screen_just_woke_up)) {
            id(screen_just_woke_up) = false;
            ESP_LOGD("backlight", "Wake flag cleared, touches now active");
          }

# MIPI-DSI Display
display:
  - platform: mipi_dsi
    id: tab5_display
    model: M5STACK-TAB5-V2
    dimensions:
      width: 720
      height: 1280
    color_order: rgb
    invert_colors: false
    reset_pin:
      pi4ioe5v6408: pi4ioe1
      number: 4
    auto_clear_enabled: false

# Get Alarmo state from Home Assistant
text_sensor:
  - platform: homeassistant
    id: alarm_state
    entity_id: alarm_control_panel.alarmo

# Global variables
globals:
  - id: pin_code
    type: std::string
    restore_value: no
    initial_value: '""'
  - id: last_touch_time
    type: uint32_t
    restore_value: no
    initial_value: '0'
  - id: screen_just_woke_up
    type: bool
    restore_value: no
    initial_value: 'false'

# Periodic alarm display update
interval:
  - interval: 1s
    then:
      - if:
          condition:
            lambda: 'return id(alarm_state).state == "disarmed";'
          then:
            - lvgl.label.update:
                id: alarm_status_label
                text: "DESARMEE"
                text_color: 0x00FF00
                bg_color: 0x000000
      - if:
          condition:
            lambda: 'return id(alarm_state).state == "armed_home";'
          then:
            - lvgl.label.update:
                id: alarm_status_label
                text: "ARMEE MAISON"
                text_color: 0xFF8800
                bg_color: 0x000000
      - if:
          condition:
            lambda: 'return id(alarm_state).state == "armed_away";'
          then:
            - lvgl.label.update:
                id: alarm_status_label
                text: "ARMEE ABSENT"
                text_color: 0xFF8800
                bg_color: 0x000000
      - if:
          condition:
            lambda: 'return id(alarm_state).state == "triggered";'
          then:
            - lvgl.label.update:
                id: alarm_status_label
                text: "ALARME!"
                text_color: 0xFF0000
                bg_color: 0x000000
      - if:
          condition:
            or:
              - lambda: 'return id(alarm_state).state == "pending";'
              - lambda: 'return id(alarm_state).state == "arming";'
          then:
            - lvgl.label.update:
                id: alarm_status_label
                text: "EN ATTENTE"
                text_color: 0xFFFF00
                bg_color: 0x000000
  
  # Automatic backlight turn-off management
  - interval: 5s
    then:
      - lambda: |-
          // Turn off backlight after 20 seconds of inactivity
          if (id(last_touch_time) > 0 && (millis() - id(last_touch_time) > 20000)) {
            if (id(backlight).remote_values.is_on()) {
              auto call = id(backlight).turn_off();
              call.perform();
              ESP_LOGD("backlight", "Backlight turned off after 20s of inactivity");
            }
          }

# Fonts with French accents
font:
  - file: "gfonts://Roboto"
    id: font_large
    size: 60
    glyphs: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789éèêëàâäùûüôöîïçÉÈÊËÀÂÄÙÛÜÔÖÎÏÇ !?.*-"
  - file: "gfonts://Roboto"
    id: font_medium
    size: 40
    glyphs: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789éèêëàâäùûüôöîïçÉÈÊËÀÂÄÙÛÜÔÖÎÏÇ !?.*-"
  - file: "gfonts://Roboto"
    id: font_small
    size: 30
    glyphs: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789éèêëàâäùûüôöîïçÉÈÊËÀÂÄÙÛÜÔÖÎÏÇ !?.*-"

# LVGL Interface - Simple black background
lvgl:
  displays:
    - tab5_display
  touchscreens:
    - touch_panel
  
  pages:
    - id: main_page
      bg_color: 0x000000
      widgets:
        # Alarm status - at the top
        - label:
            id: alarm_status_label
            align: TOP_MID
            y: 30
            text: "Chargement..."
            text_font: font_large
            text_color: 0xFFFFFF
            bg_color: 0x000000
            bg_opa: TRANSP
        
        # PIN code display
        - label:
            id: pin_display
            align: TOP_MID
            y: 120
            text: "----"
            text_font: font_medium
            text_color: 0x888888
        
        # Arming buttons row - at the top
        - obj:
            align: TOP_MID
            y: 200
            width: 480
            height: 120
            bg_opa: TRANSP
            border_width: 0
            pad_all: 0
            widgets:
              # HOME button
              - button:
                  id: btn_home
                  x: 10
                  width: 220
                  height: 110
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0x0066FF
                  border_width: 3
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_home), LV_OPA_50, 0);
                        lv_obj_set_style_bg_color(id(btn_home), lv_color_hex(0x0066FF), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_home), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        ESP_LOGD("alarmo", "HOME button pressed");
                    - homeassistant.service:
                        service: alarmo.arm
                        data:
                          entity_id: alarm_control_panel.alarmo
                          mode: home
                          skip_delay: "false"
                          force: "false"
                  widgets:
                    - label:
                        text: "MAISON"
                        text_font: font_small
                        align: CENTER
                        text_color: 0x0066FF
              
              # AWAY button
              - button:
                  id: btn_away
                  x: 250
                  width: 220
                  height: 110
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0xFF6600
                  border_width: 3
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_away), LV_OPA_50, 0);
                        lv_obj_set_style_bg_color(id(btn_away), lv_color_hex(0xFF6600), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_away), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        ESP_LOGD("alarmo", "AWAY button pressed");
                    - homeassistant.service:
                        service: alarmo.arm
                        data:
                          entity_id: alarm_control_panel.alarmo
                          mode: away
                          skip_delay: "false"
                          force: "false"
                  widgets:
                    - label:
                        text: "ABSENT"
                        text_font: font_small
                        align: CENTER
                        text_color: 0xFF6600
        
        # Large numpad - at the bottom
        - obj:
            align: BOTTOM_MID
            y: -20
            width: 680
            height: 680
            bg_opa: TRANSP
            border_width: 0
            pad_all: 0
            widgets:
              # Row 1: 1 2 3
              - button:
                  id: btn_1
                  x: 20
                  y: 10
                  width: 200
                  height: 140
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0x666666
                  border_width: 2
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_1), LV_OPA_30, 0);
                        lv_obj_set_style_bg_color(id(btn_1), lv_color_hex(0x666666), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_1), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "1";
                          lv_label_set_text(id(pin_display), std::string(id(pin_code).length(), '*').c_str());
                        }
                  widgets:
                    - label:
                        text: "1"
                        text_font: font_medium
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_2
                  x: 240
                  y: 10
                  width: 200
                  height: 140
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0x666666
                  border_width: 2
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_2), LV_OPA_30, 0);
                        lv_obj_set_style_bg_color(id(btn_2), lv_color_hex(0x666666), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_2), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "2";
                          lv_label_set_text(id(pin_display), std::string(id(pin_code).length(), '*').c_str());
                        }
                  widgets:
                    - label:
                        text: "2"
                        text_font: font_medium
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_3
                  x: 460
                  y: 10
                  width: 200
                  height: 140
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0x666666
                  border_width: 2
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_3), LV_OPA_30, 0);
                        lv_obj_set_style_bg_color(id(btn_3), lv_color_hex(0x666666), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_3), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "3";
                          lv_label_set_text(id(pin_display), std::string(id(pin_code).length(), '*').c_str());
                        }
                  widgets:
                    - label:
                        text: "3"
                        text_font: font_medium
                        align: CENTER
                        text_color: 0xFFFFFF
              
              # Line 2: 4 5 6
              - button:
                  id: btn_4
                  x: 20
                  y: 165
                  width: 200
                  height: 140
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0x666666
                  border_width: 2
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_4), LV_OPA_30, 0);
                        lv_obj_set_style_bg_color(id(btn_4), lv_color_hex(0x666666), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_4), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "4";
                          lv_label_set_text(id(pin_display), std::string(id(pin_code).length(), '*').c_str());
                        }
                  widgets:
                    - label:
                        text: "4"
                        text_font: font_medium
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_5
                  x: 240
                  y: 165
                  width: 200
                  height: 140
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0x666666
                  border_width: 2
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_5), LV_OPA_30, 0);
                        lv_obj_set_style_bg_color(id(btn_5), lv_color_hex(0x666666), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_5), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "5";
                          lv_label_set_text(id(pin_display), std::string(id(pin_code).length(), '*').c_str());
                        }
                  widgets:
                    - label:
                        text: "5"
                        text_font: font_medium
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_6
                  x: 460
                  y: 165
                  width: 200
                  height: 140
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0x666666
                  border_width: 2
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_6), LV_OPA_30, 0);
                        lv_obj_set_style_bg_color(id(btn_6), lv_color_hex(0x666666), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_6), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "6";
                          lv_label_set_text(id(pin_display), std::string(id(pin_code).length(), '*').c_str());
                        }
                  widgets:
                    - label:
                        text: "6"
                        text_font: font_medium
                        align: CENTER
                        text_color: 0xFFFFFF
              
              # Line 3: 7 8 9
              - button:
                  id: btn_7
                  x: 20
                  y: 320
                  width: 200
                  height: 140
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0x666666
                  border_width: 2
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_7), LV_OPA_30, 0);
                        lv_obj_set_style_bg_color(id(btn_7), lv_color_hex(0x666666), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_7), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "7";
                          lv_label_set_text(id(pin_display), std::string(id(pin_code).length(), '*').c_str());
                        }
                  widgets:
                    - label:
                        text: "7"
                        text_font: font_medium
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_8
                  x: 240
                  y: 320
                  width: 200
                  height: 140
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0x666666
                  border_width: 2
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_8), LV_OPA_30, 0);
                        lv_obj_set_style_bg_color(id(btn_8), lv_color_hex(0x666666), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_8), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "8";
                          lv_label_set_text(id(pin_display), std::string(id(pin_code).length(), '*').c_str());
                        }
                  widgets:
                    - label:
                        text: "8"
                        text_font: font_medium
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_9
                  x: 460
                  y: 320
                  width: 200
                  height: 140
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0x666666
                  border_width: 2
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_9), LV_OPA_30, 0);
                        lv_obj_set_style_bg_color(id(btn_9), lv_color_hex(0x666666), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_9), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "9";
                          lv_label_set_text(id(pin_display), std::string(id(pin_code).length(), '*').c_str());
                        }
                  widgets:
                    - label:
                        text: "9"
                        text_font: font_medium
                        align: CENTER
                        text_color: 0xFFFFFF
              
              # Line 4: C 0 OFF
              - button:
                  id: btn_clear
                  x: 20
                  y: 475
                  width: 200
                  height: 140
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0xFF0000
                  border_width: 2
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_clear), LV_OPA_30, 0);
                        lv_obj_set_style_bg_color(id(btn_clear), lv_color_hex(0xFF0000), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_clear), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        id(pin_code) = "";
                        lv_label_set_text(id(pin_display), "----");
                  widgets:
                    - label:
                        text: "C"
                        text_font: font_medium
                        align: CENTER
                        text_color: 0xFF0000
              
              - button:
                  id: btn_0
                  x: 240
                  y: 475
                  width: 200
                  height: 140
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0x666666
                  border_width: 2
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_0), LV_OPA_30, 0);
                        lv_obj_set_style_bg_color(id(btn_0), lv_color_hex(0x666666), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_0), LV_OPA_0, 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "0";
                          lv_label_set_text(id(pin_display), std::string(id(pin_code).length(), '*').c_str());
                        }
                  widgets:
                    - label:
                        text: "0"
                        text_font: font_medium
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_disarm
                  x: 460
                  y: 475
                  width: 200
                  height: 140
                  bg_color: 0x000000
                  bg_opa: 0
                  border_color: 0x00FF00
                  border_width: 2
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_disarm), LV_OPA_30, 0);
                        lv_obj_set_style_bg_color(id(btn_disarm), lv_color_hex(0x00FF00), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_opa(id(btn_disarm), LV_OPA_0, 0);
                  on_click:
                    - if:
                        condition:
                          lambda: 'return !id(screen_just_woke_up) && id(pin_code).length() >= 4;'
                        then:
                          - homeassistant.service:
                              service: alarm_control_panel.alarm_disarm
                              data:
                                entity_id: alarm_control_panel.alarmo
                                code: !lambda 'return id(pin_code);'
                          - lambda: |-
                              id(pin_code) = "";
                              lv_label_set_text(id(pin_display), "----");
                  widgets:
                    - label:
                        text: "OFF"
                        text_font: font_small
                        align: CENTER
                        text_color: 0x00FF00
