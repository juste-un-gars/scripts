esphome:
  name: m5stack-tab5-v2
  friendly_name: M5Stack Tab5 V2
  min_version: 2025.9.3
  on_boot:
    priority: -100
    then:
      - lambda: |-
          id(last_touch_time) = millis();

esp32:
  board: esp32-p4-evboard
  flash_size: 16MB
  framework:
    type: esp-idf
    advanced:
      enable_idf_experimental_features: true

# External components for ST7123
external_components:
  - source: github://pr#12075
    components: [st7123]
    refresh: 0s
  - source: github://pr#12074
    components: [mipi_dsi]
    refresh: 0s

# WiFi via ESP32-C6
esp32_hosted:
  variant: esp32c6
  active_high: true
  clk_pin: GPIO12
  cmd_pin: GPIO13
  d0_pin: GPIO11
  d1_pin: GPIO10
  d2_pin: GPIO9
  d3_pin: GPIO8
  reset_pin: GPIO15
  slot: 1

logger:
  hardware_uart: USB_SERIAL_JTAG

psram:
  mode: hex
  speed: 200MHz

# API Home Assistant
api:

# OTA
ota:
  - platform: esphome

# WiFi configuration
wifi:
  ssid: ""
  password: ""

# I2C bus
i2c:
  - id: bsp_bus
    sda: GPIO31
    scl: GPIO32
    frequency: 200kHz

# GPIO controllers
pi4ioe5v6408:
  - id: pi4ioe1
    address: 0x43
  - id: pi4ioe2
    address: 0x44

# Power switches
switch:
  - platform: gpio
    id: wifi_power
    pin:
      pi4ioe5v6408: pi4ioe2
      number: 0
    restore_mode: ALWAYS_ON
    internal: true
  
  # Switch pour activer/désactiver le haut-parleur
  - platform: gpio
    id: speaker_enable
    name: "Haut-parleur activé"
    pin:
      pi4ioe5v6408: pi4ioe1
      number: 1
    restore_mode: ALWAYS_ON
    internal: true

# LDO voltage regulator
esp_ldo:
  - voltage: 2.5V
    channel: 3

# PWM for backlight
output:
  - platform: ledc
    pin: GPIO22
    id: backlight_pwm
    frequency: 1000Hz

# Backlight
light:
  - platform: monochromatic
    output: backlight_pwm
    name: "Display Backlight"
    id: backlight
    restore_mode: ALWAYS_ON
    default_transition_length: 0.3s
    on_turn_on:
      - light.turn_on:
          id: backlight
          brightness: 20%

# ============================================
# CONFIGURATION AUDIO - ASSISTANT VOCAL
# ============================================

# Configuration I2S pour l'audio
i2s_audio:
  - id: mic_bus
    i2s_lrclk_pin: GPIO29
    i2s_bclk_pin: GPIO27
    i2s_mclk_pin: GPIO30

# Codec audio ES7210 pour le microphone
audio_adc:
  - platform: es7210
    id: es7210_adc
    bits_per_sample: 16bit
    sample_rate: 16000
    mic_gain: 37.5dB  # Gain maximum pour meilleure détection vocale

# Microphone
microphone:
  - platform: i2s_audio
    id: tab5_microphone
    i2s_din_pin: GPIO28
    sample_rate: 16000
    bits_per_sample: 16bit
    adc_type: external

# Codec audio ES8388 pour le haut-parleur
audio_dac:
  - platform: es8388
    id: es8388_dac

# Configuration du haut-parleur
speaker:
  - platform: i2s_audio
    id: tab5_speaker
    i2s_dout_pin: GPIO26
    audio_dac: es8388_dac
    dac_type: external
    channel: mono
    buffer_duration: 100ms
    bits_per_sample: 16bit
    sample_rate: 48000

# Sélecteur ES8388 - IMPORTANT : mettre sur LINE1 pour le haut-parleur intégré
select:
  - platform: es8388
    dac_output:
      name: "Sortie DAC"
      id: dac_output_select
    adc_input_mic:
      name: "Entrée Micro ADC"

# Assistant vocal
voice_assistant:
  id: va
  microphone: tab5_microphone
  speaker: tab5_speaker
  use_wake_word: false  # Pas de wake word en half-duplex
  noise_suppression_level: 2
  auto_gain: 31dBFS
  volume_multiplier: 2.0
  
  on_listening:
    - lambda: |-
        id(voice_assistant_listening) = true;
        ESP_LOGI("voice", "CALLBACK: En écoute - icône VERTE");
        lv_obj_set_style_text_color(id(mic_icon), lv_color_hex(0x00FF00), 0);
  
  on_stt_end:
    - lambda: |-
        id(voice_assistant_listening) = false;
        ESP_LOGI("voice", "CALLBACK: STT terminé - icône ORANGE");
        lv_obj_set_style_text_color(id(mic_icon), lv_color_hex(0xFF8800), 0);
  
  on_tts_start:
    - lambda: |-
        ESP_LOGI("voice", "CALLBACK: TTS démarré - Réponse vocale");
        // Reveiller l'ecran si eteint
        if (!id(backlight).remote_values.is_on()) {
          auto call = id(backlight).turn_on();
          call.set_brightness(0.2);
          call.perform();
        }
  
  on_end:
    - lambda: |-
        id(voice_assistant_listening) = false;
        ESP_LOGI("voice", "CALLBACK: Session terminée - icône BLANCHE");
        lv_obj_set_style_text_color(id(mic_icon), lv_color_hex(0xFFFFFF), 0);
  
  on_error:
    - lambda: |-
        id(voice_assistant_listening) = false;
        ESP_LOGE("voice", "CALLBACK: Erreur - icône ROUGE");
        lv_obj_set_style_text_color(id(mic_icon), lv_color_hex(0xFF0000), 0);
    - delay: 2s
    - lambda: |-
        lv_obj_set_style_text_color(id(mic_icon), lv_color_hex(0xFFFFFF), 0);

# ============================================
# FIN CONFIGURATION AUDIO
# ============================================

# Touchscreen ST7123 (V2)
touchscreen:
  - platform: st7123
    id: touch_panel
    i2c_id: bsp_bus
    interrupt_pin: GPIO23
    reset_pin:
      pi4ioe5v6408: pi4ioe1
      number: 5
    on_touch:
      - lambda: |-
          id(last_touch_time) = millis();
          if (!id(backlight).remote_values.is_on()) {
            // Screen was off, wake it up
            auto call = id(backlight).turn_on();
            call.set_brightness(0.2);
            call.perform();
            // Set flag to ignore button presses for 300ms
            id(screen_just_woke_up) = true;
            ESP_LOGD("backlight", "Screen woke up, ignoring touches for 300ms");
          }
    on_release:
      - delay: 300ms
      - lambda: |-
          if (id(screen_just_woke_up)) {
            id(screen_just_woke_up) = false;
            ESP_LOGD("backlight", "Wake flag cleared, touches now active");
          }

# MIPI-DSI Display
display:
  - platform: mipi_dsi
    id: tab5_display
    model: M5STACK-TAB5-V2
    dimensions:
      width: 720
      height: 1280
    color_order: rgb
    invert_colors: false
    reset_pin:
      pi4ioe5v6408: pi4ioe1
      number: 4
    auto_clear_enabled: false

# Get Alarmo state from Home Assistant
text_sensor:
  - platform: homeassistant
    id: alarm_state
    entity_id: alarm_control_panel.alarmo

# Global variables
globals:
  - id: pin_code
    type: std::string
    restore_value: no
    initial_value: '""'
  - id: last_touch_time
    type: uint32_t
    restore_value: no
    initial_value: '0'
  - id: screen_just_woke_up
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: voice_assistant_listening
    type: bool
    restore_value: no
    initial_value: 'false'

# Periodic alarm display update
interval:
  - interval: 1s
    then:
      - if:
          condition:
            lambda: 'return id(alarm_state).state == "disarmed";'
          then:
            - lvgl.label.update:
                id: alarm_status_label
                text: "DÉSARMÉE"
                text_color: 0xFFFFFF
      - if:
          condition:
            lambda: 'return id(alarm_state).state == "armed_home";'
          then:
            - lvgl.label.update:
                id: alarm_status_label
                text: "MODE MAISON"
                text_color: 0xFFFFFF
      - if:
          condition:
            lambda: 'return id(alarm_state).state == "armed_away";'
          then:
            - lvgl.label.update:
                id: alarm_status_label
                text: "MODE ABSENT"
                text_color: 0xFFFFFF
      - if:
          condition:
            lambda: 'return id(alarm_state).state == "triggered";'
          then:
            - lvgl.label.update:
                id: alarm_status_label
                text: "ALARME!"
                text_color: 0xFF0000
      - if:
          condition:
            or:
              - lambda: 'return id(alarm_state).state == "pending";'
              - lambda: 'return id(alarm_state).state == "arming";'
          then:
            - lvgl.label.update:
                id: alarm_status_label
                text: "EN ATTENTE"
                text_color: 0xFFFF00
  
  # Automatic backlight turn-off management
  - interval: 5s
    then:
      - lambda: |-
          // Turn off backlight after 20 seconds of inactivity
          if (id(last_touch_time) > 0 && (millis() - id(last_touch_time) > 20000)) {
            if (id(backlight).remote_values.is_on()) {
              auto call = id(backlight).turn_off();
              call.perform();
              ESP_LOGD("backlight", "Backlight turned off after 20s of inactivity");
            }
          }

# Fonts with French accents and MDI icons
font:
  - file: "gfonts://Roboto"
    id: font_title
    size: 32
    glyphs: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzéèêëàâäùûüôöîïçÉÈÊÀÂÔÎÏÇ0123456789!@#$%^&*()_+-=[]{}|;:',.<>?/ "
  
  - file: "gfonts://Roboto"
    id: font_button
    size: 48
    glyphs: "0123456789"
  
  - file: "gfonts://Roboto"
    id: font_label
    size: 20
    glyphs: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzéèêëàâäùûüôöîïçÉÈÊÀÂÔÎÏÇ0123456789!@#$%^&*()_+-=[]{}|;:',.<>?/ "
  
  # Font MDI pour les icônes
  - file: 'https://github.com/Templarian/MaterialDesign-Webfont/raw/master/fonts/materialdesignicons-webfont.ttf'
    id: font_mdi_large
    size: 48
    glyphs: [
      "\U000F02DC",  # mdi-home
      "\U000F04AB",  # mdi-run
      "\U000F036C",  # mdi-microphone
      "\U000F036D",  # mdi-microphone-off
      "\U000F012D",  # mdi-check
      "\U000F0156",  # mdi-close
    ]
  
  - file: 'https://github.com/Templarian/MaterialDesign-Webfont/raw/master/fonts/materialdesignicons-webfont.ttf'
    id: font_mdi_small
    size: 24
    glyphs: [
      "\U000F0142",  # mdi-dots-horizontal
      "\U000F036C",  # mdi-microphone
      "\U000F036D",  # mdi-microphone-off
    ]

# Images (si besoin)
image:
  # Vous pouvez ajouter des images personnalisées ici si nécessaire

# LVGL Configuration
lvgl:
  log_level: WARN
  color_depth: 16
  bg_color: 0x000000
  text_font: font_label
  align: center
  touchscreens:
    - touchscreen_id: touch_panel
  
  pages:
    - id: main_page
      widgets:
        # ============================================
        # ZONE SUPÉRIEURE : Titre + Micro
        # ============================================
        
        # Titre "DÉSARMÉE" / "MODE MAISON" etc.
        - label:
            id: alarm_status_label
            text: "DÉSARMÉE"
            x: 0
            y: 40
            width: 720
            align: TOP_MID
            text_align: CENTER
            text_font: font_title
            text_color: 0xFFFFFF
        
        # Bouton MICRO en haut à droite - PUSH TO TALK
        - button:
            id: mic_button
            x: 650
            y: 20
            width: 60
            height: 60
            align: TOP_LEFT
            bg_color: 0x2A2A2A
            bg_opa: COVER
            border_width: 0
            radius: 30
            on_press:
              - lambda: |-
                  if (id(screen_just_woke_up)) return;
                  ESP_LOGI("voice", "Micro APPUYÉ - Démarrage écoute");
                  lv_obj_set_style_text_color(id(mic_icon), lv_color_hex(0x00FF00), 0);
              - voice_assistant.start:
            on_release:
              - lambda: |-
                  ESP_LOGI("voice", "Micro RELÂCHÉ - Fin d'enregistrement, traitement en cours...");
                  lv_obj_set_style_text_color(id(mic_icon), lv_color_hex(0xFF8800), 0);
              # Le voice_assistant continue et se termine via on_end callback
            widgets:
              - label:
                  id: mic_icon
                  text: "\U000F036C"  # mdi-microphone
                  text_font: font_mdi_large
                  align: CENTER
                  text_color: 0xFFFFFF
        
        # ============================================
        # ZONE CENTRALE : Boutons MAISON / ABSENT
        # ============================================
        
        # Conteneur pour les boutons du haut
        - obj:
            x: 0
            y: 150
            width: 720
            height: 100
            align: TOP_MID
            bg_opa: TRANSP
            border_width: 0
            pad_all: 0
            widgets:
              # Bouton MAISON
              - button:
                  id: btn_home
                  x: 120
                  y: 0
                  width: 190
                  height: 80
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_color: 0x00FF00
                  border_width: 2
                  radius: 15
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_home), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_home), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        ESP_LOGD("alarmo", "HOME button pressed");
                    - homeassistant.service:
                        service: alarmo.arm
                        data:
                          entity_id: alarm_control_panel.alarmo
                          mode: home
                          skip_delay: "false"
                          force: "false"
                  widgets:
                    - label:
                        text: "\U000F02DC"  # mdi-home
                        text_font: font_mdi_large
                        x: 20
                        align: LEFT_MID
                        text_color: 0xFFFFFF
                    - label:
                        text: "MAISON"
                        text_font: font_label
                        x: 75
                        align: LEFT_MID
                        text_color: 0xFFFFFF
              
              # Bouton ABSENT
              - button:
                  id: btn_away
                  x: 410
                  y: 0
                  width: 190
                  height: 80
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_color: 0x0088FF
                  border_width: 2
                  radius: 15
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_away), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_away), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        ESP_LOGD("alarmo", "AWAY button pressed");
                    - homeassistant.service:
                        service: alarmo.arm
                        data:
                          entity_id: alarm_control_panel.alarmo
                          mode: away
                          skip_delay: "false"
                          force: "false"
                  widgets:
                    - label:
                        text: "\U000F04AB"  # mdi-run
                        text_font: font_mdi_large
                        x: 20
                        align: LEFT_MID
                        text_color: 0xFFFFFF
                    - label:
                        text: "ABSENT"
                        text_font: font_label
                        x: 75
                        align: LEFT_MID
                        text_color: 0xFFFFFF
        
        # ============================================
        # ZONE PAVÉ NUMÉRIQUE
        # ============================================
        
        # Conteneur pour le pavé numérique
        - obj:
            x: 0
            y: 520
            width: 720
            height: 900
            align: TOP_MID
            bg_opa: TRANSP
            border_width: 0
            pad_all: 0
            widgets:
              # Ligne 1 : 1 2 3
              - button:
                  id: btn_1
                  x: 90
                  y: 20
                  width: 160
                  height: 160
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_width: 0
                  radius: 25
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_1), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_1), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "1";
                        }
                  widgets:
                    - label:
                        text: "1"
                        text_font: font_button
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_2
                  x: 280
                  y: 20
                  width: 160
                  height: 160
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_width: 0
                  radius: 25
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_2), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_2), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "2";
                        }
                  widgets:
                    - label:
                        text: "2"
                        text_font: font_button
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_3
                  x: 470
                  y: 20
                  width: 160
                  height: 160
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_width: 0
                  radius: 25
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_3), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_3), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "3";
                        }
                  widgets:
                    - label:
                        text: "3"
                        text_font: font_button
                        align: CENTER
                        text_color: 0xFFFFFF
              
              # Ligne 2 : 4 5 6
              - button:
                  id: btn_4
                  x: 90
                  y: 200
                  width: 160
                  height: 160
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_width: 0
                  radius: 25
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_4), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_4), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "4";
                        }
                  widgets:
                    - label:
                        text: "4"
                        text_font: font_button
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_5
                  x: 280
                  y: 200
                  width: 160
                  height: 160
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_width: 0
                  radius: 25
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_5), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_5), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "5";
                        }
                  widgets:
                    - label:
                        text: "5"
                        text_font: font_button
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_6
                  x: 470
                  y: 200
                  width: 160
                  height: 160
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_width: 0
                  radius: 25
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_6), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_6), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "6";
                        }
                  widgets:
                    - label:
                        text: "6"
                        text_font: font_button
                        align: CENTER
                        text_color: 0xFFFFFF
              
              # Ligne 3 : 7 8 9
              - button:
                  id: btn_7
                  x: 90
                  y: 380
                  width: 160
                  height: 160
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_width: 0
                  radius: 25
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_7), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_7), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "7";
                        }
                  widgets:
                    - label:
                        text: "7"
                        text_font: font_button
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_8
                  x: 280
                  y: 380
                  width: 160
                  height: 160
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_width: 0
                  radius: 25
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_8), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_8), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "8";
                        }
                  widgets:
                    - label:
                        text: "8"
                        text_font: font_button
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_9
                  x: 470
                  y: 380
                  width: 160
                  height: 160
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_width: 0
                  radius: 25
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_9), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_9), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "9";
                        }
                  widgets:
                    - label:
                        text: "9"
                        text_font: font_button
                        align: CENTER
                        text_color: 0xFFFFFF
              
              # Ligne 4 : CLEAR 0 VALIDATE
              - button:
                  id: btn_clear
                  x: 90
                  y: 560
                  width: 160
                  height: 160
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_width: 0
                  radius: 25
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_clear), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_clear), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        id(pin_code) = "";
                  widgets:
                    - label:
                        text: "\U000F0156"  # mdi-close
                        text_font: font_mdi_large
                        align: CENTER
                        text_color: 0xFF6666
              
              - button:
                  id: btn_0
                  x: 280
                  y: 560
                  width: 160
                  height: 160
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_width: 0
                  radius: 25
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_0), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_0), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - lambda: |-
                        if (id(screen_just_woke_up)) return;
                        if (id(pin_code).length() < 6) {
                          id(pin_code) += "0";
                        }
                  widgets:
                    - label:
                        text: "0"
                        text_font: font_button
                        align: CENTER
                        text_color: 0xFFFFFF
              
              - button:
                  id: btn_validate
                  x: 470
                  y: 560
                  width: 160
                  height: 160
                  bg_color: 0x2A2A2A
                  bg_opa: COVER
                  border_width: 0
                  radius: 25
                  on_press:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_validate), lv_color_hex(0x3A3A3A), 0);
                  on_release:
                    - lambda: |-
                        lv_obj_set_style_bg_color(id(btn_validate), lv_color_hex(0x2A2A2A), 0);
                  on_click:
                    - if:
                        condition:
                          lambda: 'return !id(screen_just_woke_up) && id(pin_code).length() >= 4;'
                        then:
                          - homeassistant.service:
                              service: alarm_control_panel.alarm_disarm
                              data:
                                entity_id: alarm_control_panel.alarmo
                                code: !lambda 'return id(pin_code);'
                          - lambda: |-
                              id(pin_code) = "";
                  widgets:
                    - label:
                        text: "\U000F012D"  # mdi-check
                        text_font: font_mdi_large
                        align: CENTER
                        text_color: 0x66FF66
